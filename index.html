<script>
/* =========================
   PAGE SYSTEM ENGINE
========================= */

const PageSystem = {
  pages: {},
  current: null,

  register(name, config) {
    this.pages[name] = config;
  },

  mount(name) {
    const page = this.pages[name];
    if (!page) return;

    this.current = name;

    document.getElementById("app").innerHTML = page.render();
    page.onMount && page.onMount();

    document.querySelectorAll("nav button").forEach(btn => {
      btn.classList.toggle("active", btn.dataset.page === name);
    });
  }
};

/* =========================
   NAV RENDER
========================= */

function renderNav() {
  const nav = document.querySelector("nav");
  nav.innerHTML = "";

  Object.keys(PageSystem.pages).forEach(name => {
    const btn = document.createElement("button");
    btn.innerText = name;
    btn.dataset.page = name;
    btn.onclick = () => PageSystem.mount(name);
    nav.appendChild(btn);
  });
}

/* =========================
   ROOT APP CONTAINER
========================= */

document.body.insertAdjacentHTML(
  "beforeend",
  `<div id="app" style="padding:20px;"></div>`
);

/* =========================
   DEFAULT PAGES (PHASE 1)
========================= */

PageSystem.register("Dashboard", {
  render() {
    return `
      <div class="card">
        <h3>System Overview</h3>
        <p class="small">Core Version: ${Core.version}</p>
        <p>Overall GPA: <b>${GPAEngine.calculateOverall()}</b></p>
        <p>${AIAdvisor.advise()}</p>
      </div>
    `;
  }
});

PageSystem.register("Profile", {
  render() {
    const p = Core.state.user || {};
    return `
      <div class="card">
        <h3>Student Profile</h3>
        <input id="name" placeholder="Name" value="${p.name || ""}">
        <input id="major" placeholder="Major" value="${p.major || ""}">
        <button class="primary" onclick="saveProfile()">Save</button>
      </div>
    `;
  }
});

/* =========================
   PAGE ACTIONS
========================= */

function saveProfile() {
  Core.state.user.name = document.getElementById("name").value;
  Core.state.user.major = document.getElementById("major").value;
  Core.emit("profile:update");
}

/* =========================
   SYSTEM BOOT (PHASE 1)
========================= */

renderNav();
PageSystem.mount("Dashboard");
</script>
<script>
/* =========================
   PHASE 2A: COURSE ENGINE
========================= */

/*
 数据结构设计（非常重要）
 Core.state.semesters = [
   {
     id,
     name,
     courses: [
       {
         id,
         name,
         credits,
         grade,
         status // normal | pass | fail | withdraw
       }
     ]
   }
 ]
*/

function uid() {
  return Math.random().toString(36).slice(2, 10);
}

/* =========================
   SEMESTER OPERATIONS
========================= */

const SemesterAPI = {
  create(name) {
    const semester = {
      id: uid(),
      name,
      courses: []
    };
    Core.state.semesters.push(semester);
    Core.emit("semester:create", semester);
  },

  remove(id) {
    Core.state.semesters =
      Core.state.semesters.filter(s => s.id !== id);
    Core.emit("semester:remove", id);
  },

  get(id) {
    return Core.state.semesters.find(s => s.id === id);
  }
};

/* =========================
   COURSE OPERATIONS
========================= */

const CourseAPI = {
  add(semesterId, data) {
    const sem = SemesterAPI.get(semesterId);
    if (!sem) return;

    sem.courses.push({
      id: uid(),
      name: data.name || "Untitled Course",
      credits: Number(data.credits) || 0,
      grade: data.grade || "A",
      status: data.status || "normal"
    });

    Core.emit("course:add", semesterId);
  },

  update(semesterId, courseId, patch) {
    const sem = SemesterAPI.get(semesterId);
    if (!sem) return;

    const c = sem.courses.find(c => c.id === courseId);
    if (!c) return;

    Object.assign(c, patch);
    Core.emit("course:update", { semesterId, courseId });
  },

  remove(semesterId, courseId) {
    const sem = SemesterAPI.get(semesterId);
    if (!sem) return;

    sem.courses = sem.courses.filter(c => c.id !== courseId);
    Core.emit("course:remove", { semesterId, courseId });
  }
};

/* =========================
   GPA ENGINE UPGRADE
========================= */

GPAEngine.calculateSemester = function (semester) {
  let pts = 0, cr = 0;

  semester.courses.forEach(c => {
    if (c.status === "withdraw") return;

    const g = this.gradeMap[c.grade];
    if (g === undefined) return;

    pts += g * c.credits;
    cr += c.credits;
  });

  return cr ? (pts / cr) : 0;
};

GPAEngine.calculateOverall = function () {
  let totalPts = 0;
  let totalCr = 0;

  Core.state.semesters.forEach(s => {
    s.courses.forEach(c => {
      if (c.status === "withdraw") return;
      const g = this.gradeMap[c.grade];
      if (g === undefined) return;

      totalPts += g * c.credits;
      totalCr += c.credits;
    });
  });

  return totalCr ? (totalPts / totalCr).toFixed(2) : "—";
};

/* =========================
   SYSTEM EVENTS (HOOKS)
========================= */

Core.on("semester:create", () => {
  console.log("Semester created");
});

Core.on("course:add", () => {
  console.log("Course added");
});

</script>
